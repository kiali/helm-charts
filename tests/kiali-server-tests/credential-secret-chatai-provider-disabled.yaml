name: "credential_secret_chatai_provider_disabled"
description: "Verify chat_ai provider credentials are NOT mounted when provider.enabled is false"
helm_args:
  - "--set"
  - "chat_ai.enabled=true"
  - "--set"
  - "chat_ai.default_provider=openai"
  - "--set"
  - "chat_ai.providers[0].name=openai"
  - "--set"
  - "chat_ai.providers[0].type=openai"
  - "--set"
  - "chat_ai.providers[0].config=default"
  - "--set"
  - "chat_ai.providers[0].enabled=true"
  - "--set"
  - "chat_ai.providers[0].default_model=gpt4"
  - "--set"
  - "chat_ai.providers[0].key=secret:ai-provider-creds:api-key"
  - "--set"
  - "chat_ai.providers[0].models[0].name=gpt4"
  - "--set"
  - "chat_ai.providers[0].models[0].model=gpt-4"
  - "--set"
  - "chat_ai.providers[0].models[0].enabled=true"
  - "--set"
  - "chat_ai.providers[0].models[0].key=secret:ai-model-creds:model-api-key"
  - "--set"
  - "chat_ai.providers[1].name=azure"
  - "--set"
  - "chat_ai.providers[1].type=openai"
  - "--set"
  - "chat_ai.providers[1].config=azure"
  - "--set"
  - "chat_ai.providers[1].enabled=false"
  - "--set"
  - "chat_ai.providers[1].default_model=gpt35"
  - "--set"
  - "chat_ai.providers[1].key=secret:ai-provider-creds:azure-api-key"
  - "--set"
  - "chat_ai.providers[1].models[0].name=gpt35"
  - "--set"
  - "chat_ai.providers[1].models[0].model=gpt-35-turbo"
  - "--set"
  - "chat_ai.providers[1].models[0].enabled=true"
  - "--set"
  - "chat_ai.providers[1].models[0].key=secret:ai-model-creds:azure-model-api-key"
yq_query: "select(.kind == \"Deployment\") | {\"provider_openai\": (.spec.template.spec.volumes | map(select(.name == \"chat-ai-provider-openai\")) | length), \"model_openai_gpt4\": (.spec.template.spec.volumes | map(select(.name == \"chat-ai-model-openai-gpt4\")) | length), \"provider_azure\": (.spec.template.spec.volumes | map(select(.name == \"chat-ai-provider-azure\")) | length), \"model_azure_gpt35\": (.spec.template.spec.volumes | map(select(.name == \"chat-ai-model-azure-gpt35\")) | length)}"
expected_result: |
  provider_openai: 1
  model_openai_gpt4: 1
  provider_azure: 0
  model_azure_gpt35: 0
should_fail: false
