name: "credential_secret_chatai_multiple"
description: "Verify multiple chat_ai provider and model secrets are all auto-mounted"
helm_args:
  - "--set"
  - "chat_ai.enabled=true"
  - "--set"
  - "chat_ai.default_provider=openai"
  # First provider with provider-level key and model-level key
  - "--set"
  - "chat_ai.providers[0].name=openai"
  - "--set"
  - "chat_ai.providers[0].type=openai"
  - "--set"
  - "chat_ai.providers[0].config=default"
  - "--set"
  - "chat_ai.providers[0].enabled=true"
  - "--set"
  - "chat_ai.providers[0].default_model=gpt4"
  - "--set"
  - "chat_ai.providers[0].key=secret:openai-creds:provider-key"
  - "--set"
  - "chat_ai.providers[0].models[0].name=gpt4"
  - "--set"
  - "chat_ai.providers[0].models[0].model=gpt-4"
  - "--set"
  - "chat_ai.providers[0].models[0].enabled=true"
  - "--set"
  - "chat_ai.providers[0].models[0].key=secret:openai-creds:gpt4-key"
  # Second provider with provider-level key and model-level key
  - "--set"
  - "chat_ai.providers[1].name=azure"
  - "--set"
  - "chat_ai.providers[1].type=openai"
  - "--set"
  - "chat_ai.providers[1].config=azure"
  - "--set"
  - "chat_ai.providers[1].enabled=true"
  - "--set"
  - "chat_ai.providers[1].default_model=gpt35"
  - "--set"
  - "chat_ai.providers[1].key=secret:azure-creds:provider-key"
  - "--set"
  - "chat_ai.providers[1].models[0].name=gpt35"
  - "--set"
  - "chat_ai.providers[1].models[0].model=gpt-35-turbo"
  - "--set"
  - "chat_ai.providers[1].models[0].enabled=true"
  - "--set"
  - "chat_ai.providers[1].models[0].key=secret:azure-creds:gpt35-key"
yq_query: "select(.kind == \"Deployment\") | (.spec.template.spec.volumes | map(select(.name == \"chat-ai-provider-openai\" or .name == \"chat-ai-model-openai-gpt4\" or .name == \"chat-ai-provider-azure\" or .name == \"chat-ai-model-azure-gpt35\")) | sort_by(.name))"
expected_result: |
  - name: chat-ai-model-azure-gpt35
    secret:
      secretName: azure-creds
      items:
        - key: gpt35-key
          path: value.txt
  - name: chat-ai-model-openai-gpt4
    secret:
      secretName: openai-creds
      items:
        - key: gpt4-key
          path: value.txt
  - name: chat-ai-provider-azure
    secret:
      secretName: azure-creds
      items:
        - key: provider-key
          path: value.txt
  - name: chat-ai-provider-openai
    secret:
      secretName: openai-creds
      items:
        - key: provider-key
          path: value.txt
should_fail: false
