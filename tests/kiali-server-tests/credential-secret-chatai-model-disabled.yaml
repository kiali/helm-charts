name: "credential_secret_chatai_model_disabled"
description: "Verify chat_ai model credentials are NOT mounted when model.enabled is false"
helm_args:
  - "--set"
  - "chat_ai.enabled=true"
  - "--set"
  - "chat_ai.default_provider=openai"
  - "--set"
  - "chat_ai.providers[0].name=openai"
  - "--set"
  - "chat_ai.providers[0].type=openai"
  - "--set"
  - "chat_ai.providers[0].config=default"
  - "--set"
  - "chat_ai.providers[0].enabled=true"
  - "--set"
  - "chat_ai.providers[0].default_model=gpt4"
  - "--set"
  - "chat_ai.providers[0].models[0].name=gpt4"
  - "--set"
  - "chat_ai.providers[0].models[0].model=gpt-4"
  - "--set"
  - "chat_ai.providers[0].models[0].enabled=true"
  - "--set"
  - "chat_ai.providers[0].models[0].key=secret:ai-model-creds:gpt4-api-key"
  - "--set"
  - "chat_ai.providers[0].models[1].name=gpt35"
  - "--set"
  - "chat_ai.providers[0].models[1].model=gpt-35-turbo"
  - "--set"
  - "chat_ai.providers[0].models[1].enabled=false"
  - "--set"
  - "chat_ai.providers[0].models[1].key=secret:ai-model-creds:gpt35-api-key"
yq_query: "select(.kind == \"Deployment\") | {\"enabled\": (.spec.template.spec.volumes | map(select(.name == \"chat-ai-model-openai-gpt4\")) | length), \"disabled\": (.spec.template.spec.volumes | map(select(.name == \"chat-ai-model-openai-gpt35\")) | length)}"
expected_result: |
  enabled: 1
  disabled: 0
should_fail: false
