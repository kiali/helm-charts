name: "custom_secrets_csi"
description: "Verify custom secrets with CSI driver configuration"
helm_args:
  - "--set"
  - "deployment.custom_secrets[0].name=csi-secret"
  - "--set"
  - "deployment.custom_secrets[0].mount=/csi/mount"
  - "--set"
  - "deployment.custom_secrets[0].csi.driver=secrets-store.csi.k8s.io"
  - "--set"
  - "deployment.custom_secrets[0].csi.readOnly=true"
  - "--set"
  - "deployment.custom_secrets[0].csi.volumeAttributes.secretProviderClass=my-secret-provider"
yq_query: "select(.kind == \"Deployment\") | .spec.template.spec.volumes | map(select(.name == \"csi-secret\")) | .[0].csi"
expected_result: |
  driver: secrets-store.csi.k8s.io
  readOnly: true
  volumeAttributes:
    secretProviderClass: my-secret-provider
should_fail: false
