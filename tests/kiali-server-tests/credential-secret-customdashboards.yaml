name: "credential_secret_customdashboards"
description: "Verify custom dashboards prometheus credentials are mounted with correct path names (no hyphen in 'customdashboards')"
helm_args:
  - "--set"
  - "external_services.custom_dashboards.enabled=true"
  - "--set"
  - "external_services.custom_dashboards.prometheus.url=http://prometheus:9090"
  - "--set"
  - "external_services.custom_dashboards.prometheus.auth.username=secret:cd-prom-creds:user"
  - "--set"
  - "external_services.custom_dashboards.prometheus.auth.password=secret:cd-prom-creds:pass"
yq_query: "select(.kind == \"Deployment\") | {\"volumes\": (.spec.template.spec.volumes | map(select(.name | test(\"^customdashboards-prometheus\"))) | sort_by(.name)), \"mounts\": (.spec.template.spec.containers[0].volumeMounts | map(select(.name | test(\"^customdashboards-prometheus\"))) | sort_by(.name))}"
expected_result: |
  volumes:
    - name: customdashboards-prometheus-password
      secret:
        secretName: cd-prom-creds
        items:
          - key: pass
            path: value.txt
    - name: customdashboards-prometheus-username
      secret:
        secretName: cd-prom-creds
        items:
          - key: user
            path: value.txt
  mounts:
    - name: customdashboards-prometheus-password
      mountPath: "/kiali-override-secrets/customdashboards-prometheus-password"
      readOnly: true
    - name: customdashboards-prometheus-username
      mountPath: "/kiali-override-secrets/customdashboards-prometheus-username"
      readOnly: true
should_fail: false

