name: "deployment_containers_security_block"
description: "Verify user security overrides are blocked"
helm_args:
  - "--set"
  - "deployment.additional_pod_containers_yaml[0].name=privilege-attempt"
  - "--set"
  - "deployment.additional_pod_containers_yaml[0].image=registry.access.redhat.com/ubi9/ubi-minimal:latest"
  - "--set"
  - "deployment.additional_pod_containers_yaml[0].command[0]=sh"
  - "--set"
  - "deployment.additional_pod_containers_yaml[0].command[1]=-c"
  - "--set"
  - "deployment.additional_pod_containers_yaml[0].command[2]=echo test"
  - "--set"
  - "deployment.additional_pod_containers_yaml[0].securityContext.privileged=true"
  - "--set"
  - "deployment.additional_pod_containers_yaml[0].securityContext.allowPrivilegeEscalation=true"
  - "--set"
  - "deployment.additional_pod_containers_yaml[0].securityContext.readOnlyRootFilesystem=false"
  - "--set"
  - "deployment.additional_pod_containers_yaml[0].securityContext.runAsNonRoot=false"
yq_query: ".spec.template.spec.containers[0].securityContext"
expected_result: |
  allowPrivilegeEscalation: false
  capabilities:
    drop:
      - ALL
  privileged: false
  readOnlyRootFilesystem: true
  runAsNonRoot: true
should_fail: false
