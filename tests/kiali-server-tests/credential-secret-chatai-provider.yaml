name: "credential_secret_chatai_provider"
description: "Verify chat_ai provider key secret is auto-mounted when using secret:<name>:<key> pattern"
helm_args:
  - "--set"
  - "chat_ai.enabled=true"
  - "--set"
  - "chat_ai.default_provider=openai"
  - "--set"
  - "chat_ai.providers[0].name=openai"
  - "--set"
  - "chat_ai.providers[0].type=openai"
  - "--set"
  - "chat_ai.providers[0].config=default"
  - "--set"
  - "chat_ai.providers[0].enabled=true"
  - "--set"
  - "chat_ai.providers[0].default_model=gpt4"
  - "--set"
  - "chat_ai.providers[0].key=secret:ai-provider-creds:api-key"
  - "--set"
  - "chat_ai.providers[0].models[0].name=gpt4"
  - "--set"
  - "chat_ai.providers[0].models[0].model=gpt-4"
  - "--set"
  - "chat_ai.providers[0].models[0].enabled=true"
yq_query: "select(.kind == \"Deployment\") | {\"volume\": (.spec.template.spec.volumes | map(select(.name == \"chat-ai-provider-openai\")) | .[0]), \"volumeMount\": (.spec.template.spec.containers[] | select(.name == \"kiali\") | .volumeMounts | map(select(.name == \"chat-ai-provider-openai\")) | .[0])}"
expected_result: |
  volume:
    name: chat-ai-provider-openai
    secret:
      secretName: ai-provider-creds
      items:
        - key: api-key
          path: value.txt
  volumeMount:
    name: chat-ai-provider-openai
    mountPath: "/kiali-override-secrets/chat-ai-provider-openai"
    readOnly: true
should_fail: false
