name: "credential_secret_multiple"
description: "Verify multiple credential secrets from different services are all auto-mounted"
helm_args:
  - "--set"
  - "external_services.prometheus.auth.password=secret:prom-creds:password"
  - "--set"
  - "external_services.prometheus.auth.token=secret:prom-creds:token"
  - "--set"
  - "external_services.grafana.enabled=true"
  - "--set"
  - "external_services.grafana.auth.token=secret:grafana-creds:api-token"
yq_query: "select(.kind == \"Deployment\") | (.spec.template.spec.volumes | map(select(.name == \"prometheus-password\" or .name == \"prometheus-token\" or .name == \"grafana-token\")) | sort_by(.name))"
expected_result: |
  - name: grafana-token
    secret:
      secretName: grafana-creds
      items:
        - key: api-token
          path: value.txt
  - name: prometheus-password
    secret:
      secretName: prom-creds
      items:
        - key: password
          path: value.txt
  - name: prometheus-token
    secret:
      secretName: prom-creds
      items:
        - key: token
          path: value.txt
should_fail: false

