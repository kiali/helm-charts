name: "deployment_init_containers_security"
description: "Verify security context is enforced on multiple initContainers despite override attempts"
helm_args:
  - "--set"
  - "deployment.additional_pod_init_containers_yaml[0].name=init-1"
  - "--set"
  - "deployment.additional_pod_init_containers_yaml[0].image=registry.access.redhat.com/ubi9/ubi-minimal:latest"
  - "--set"
  - "deployment.additional_pod_init_containers_yaml[0].command[0]=echo"
  - "--set"
  - "deployment.additional_pod_init_containers_yaml[0].command[1]=first"
  - "--set"
  - "deployment.additional_pod_init_containers_yaml[1].name=init-2"
  - "--set"
  - "deployment.additional_pod_init_containers_yaml[1].image=registry.access.redhat.com/ubi9/ubi-minimal:latest"
  - "--set"
  - "deployment.additional_pod_init_containers_yaml[1].command[0]=echo"
  - "--set"
  - "deployment.additional_pod_init_containers_yaml[1].command[1]=second"
  - "--set"
  - "deployment.additional_pod_init_containers_yaml[1].securityContext.privileged=true"
yq_query: "select(.kind == \"Deployment\") | {\"firstInitContainerSecurity\": .spec.template.spec.initContainers[0].securityContext, \"secondInitContainerSecurity\": .spec.template.spec.initContainers[1].securityContext}"
expected_result: |
  firstInitContainerSecurity:
    allowPrivilegeEscalation: false
    capabilities:
      drop:
        - ALL
    privileged: false
    readOnlyRootFilesystem: true
    runAsNonRoot: true
  secondInitContainerSecurity:
    allowPrivilegeEscalation: false
    capabilities:
      drop:
        - ALL
    privileged: false
    readOnlyRootFilesystem: true
    runAsNonRoot: true
should_fail: false
