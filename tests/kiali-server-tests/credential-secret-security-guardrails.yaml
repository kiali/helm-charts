name: "credential_secret_security_guardrails"
description: "Verify credential secrets are protected by security guardrails and force read-only mounts"
helm_args:
  - "--set"
  - "external_services.prometheus.auth.password=secret:prom-creds:password"
  - "--set"
  - "deployment.additional_pod_containers_yaml[0].name=sidecar"
  - "--set"
  - "deployment.additional_pod_containers_yaml[0].image=busybox"
  - "--set"
  - "deployment.additional_pod_containers_yaml[0].command[0]=sleep"
  - "--set"
  - "deployment.additional_pod_containers_yaml[0].command[1]=infinity"
  - "--set"
  - "deployment.additional_pod_containers_yaml[0].volumeMounts[0].name=prometheus-password"
  - "--set"
  - "deployment.additional_pod_containers_yaml[0].volumeMounts[0].mountPath=/test-creds"
yq_query: "select(.kind == \"Deployment\") | (.spec.template.spec.containers | map(select(.name == \"sidecar\")) | .[0].volumeMounts | map(select(.name == \"prometheus-password\")) | .[0])"
expected_result: |
  mountPath: /test-creds
  name: prometheus-password
  readOnly: true
should_fail: false

